# 画像管理設計（AWS S3採用）

## 1. 概要

本ドキュメントは、TraMemoプロジェクトにおける画像管理方式としてAWS S3を採用した場合の設計・実装フローをまとめたものです。バックエンド（Laravel）、フロントエンド（React）双方の観点を含みます。

---

## 2. 要件整理
- 旅行記録の写真をユーザーがアップロード
- 画像はAWS S3に保存
- 画像の取得・表示はS3のURLを利用
- サムネイル生成・削除も対応
- セキュリティ（認証・公開/非公開）を考慮
- 将来的なCDN（CloudFront）連携も視野

---

## 3. バックエンド（Laravel）

### 3.1 S3ストレージ設定
- `.env`にS3のアクセスキー、シークレット、バケット名、リージョンを記載
- `config/filesystems.php`で`s3`ディスクを有効化

### 3.2 DB設計（photosテーブル例）
| カラム名         | 型       | 制約                   | 概要                |
|:----------------|:---------|:----------------------|:--------------------|
| id              | BIGINT   | PK, AUTO INCREMENT    | 写真ID              |
| travel_id       | BIGINT   | FK(travels.id), NULLABLE | 旅行ID（未紐付時NULL）|
| user_id         | BIGINT   | FK(users.id)          | 投稿ユーザーID      |
| file_path       | TEXT     | NOT NULL              | S3上のファイルパス  |
| thumbnail_path  | TEXT     | NULLABLE              | サムネイルパス      |
| caption         | TEXT     | NULLABLE              | キャプション        |
| created_at      | TIMESTAMP|                       | 作成日時            |
| updated_at      | TIMESTAMP|                       | 更新日時            |

---

## 4. API設計

### 4.1 画像アップロード
#### エンドポイント
```
POST /api/photos
```
#### 認証
- 必須（JWT/セッション等）

#### リクエスト（multipart/form-data）
| パラメータ   | 型     | 必須 | 説明           |
|-------------|--------|------|----------------|
| image       | file   | ○    | 画像ファイル    |
| travel_id   | int    | ×    | 紐付ける旅行ID  |
| caption     | string | ×    | キャプション    |

#### バリデーション
- 画像形式（jpg/png/webp等）
- 最大サイズ（例: 5MB）
- travel_id指定時は存在チェック

#### レスポンス例
```json
{
  "success": true,
  "data": {
    "id": 101,
    "url": "https://s3.amazonaws.com/bucket/xxx.jpg",
    "thumbnail_url": "https://s3.amazonaws.com/bucket/xxx_thumb.jpg",
    "travel_id": null,
    "caption": "集合写真"
  }
}
```

---

### 4.2 画像取得
#### エンドポイント
```
GET /api/photos/{id}
```
#### 認証
- 不要（公開画像の場合）
- 必要（非公開画像の場合、または署名付きURL発行時）

#### レスポンス例
```json
{
  "success": true,
  "data": {
    "id": 101,
    "url": "https://s3.amazonaws.com/bucket/xxx.jpg",
    "thumbnail_url": "https://s3.amazonaws.com/bucket/xxx_thumb.jpg",
    "travel_id": 55,
    "caption": "集合写真"
  }
}
```

---

### 4.3 画像削除
#### エンドポイント
```
DELETE /api/photos/{id}
```
#### 認証
- 必須（画像の所有者または管理者のみ）

#### レスポンス例
```json
{
  "success": true,
  "message": "Photo deleted successfully."
}
```

---

### 4.4 画像一覧取得（旅行記録単位）
#### エンドポイント
```
GET /api/travels/{travel_id}/photos
```
#### 認証
- 不要（公開旅行記録の場合）
- 必要（非公開の場合）

#### レスポンス例
```json
{
  "success": true,
  "data": [
    {
      "id": 101,
      "url": "https://s3.amazonaws.com/bucket/xxx.jpg",
      "thumbnail_url": "https://s3.amazonaws.com/bucket/xxx_thumb.jpg",
      "caption": "集合写真"
    },
    ...
  ]
}
```

---

### 4.5 S3署名付きURL方式（オプション）
#### アップロード用URL発行
```
POST /api/photos/presign
```
- バックエンドでS3のpresigned URLを発行し、フロントはそのURLに直接PUT/POST
- presigned URLの有効期限・ファイル名・Content-Type等を指定

#### レスポンス例
```json
{
  "success": true,
  "data": {
    "upload_url": "https://s3.amazonaws.com/bucket/xxx.jpg?AWSAccessKeyId=...",
    "file_path": "photos/2025/07/01/xxx.jpg"
  }
}
```
- アップロード後、DB登録用APIでfile_path等を登録

---

## 5. フロントエンド（React）

### 5.1 画像アップロードUI
- ドラッグ＆ドロップ、プレビュー表示
- 複数選択・進捗バー対応
- FormDataでAPIへPOST、またはpresigned URLに直接PUT

### 5.2 画像表示
- APIから受け取った画像URLをimgタグで表示
- サムネイル優先、なければオリジナル

### 5.3 画像削除
- UI上で削除→API呼び出し→成功時に画面から除去

### 5.4 エラーハンドリング
- アップロード失敗時のメッセージ表示
- サイズ・拡張子制限の事前チェック

---

## 6. データ処理フロー（分離型）

### 6.1 データ処理の流れ

#### ① 画像アップロード（旅行記録作成前）
1. ユーザーが画像を選択し、画像アップロードAPI（POST /api/photos）を呼ぶ
2. バックエンドは画像をS3に保存し、photosテーブルにレコードを作成
    - travel_idはNULL（未紐付）
    - user_id, file_path, created_at等を保存
3. APIは画像IDやURLを返す
4. フロントエンドは画像のプレビューや一時的な画像リストを保持

#### ② 旅行記録作成
1. ユーザーが旅行記録の入力を完了し、作成API（POST /api/travels）を呼ぶ
    - リクエストボディに「画像IDの配列」または「画像URLの配列」を含める（例: photo_ids: [101, 102]）
2. バックエンドはtravelレコードを新規作成
3. photosテーブルの該当レコードのtravel_idを、作成したtravelのIDに更新（UPDATE）
4. レスポンスで旅行記録と紐付いた画像情報を返す

#### ③ 未紐付画像のクリーンアップ
- 旅行記録作成がキャンセルされた場合や、アップロード後に放置された画像は、定期的なバッチ等で削除（travel_idがNULLかつ一定期間経過したもの）

### 6.2 DB設計イメージ

| id  | travel_id | user_id | file_path | ... | created_at |
|-----|-----------|---------|-----------|-----|------------|
|101  | NULL      | 1       | ...       | ... | ...        | ←アップロード直後
|101  | 55        | 1       | ...       | ... | ...        | ←旅行記録作成後

### 6.3 運用ポイント
- 旅行記録作成時に画像IDを指定しない場合は未紐付のまま（後で削除対象）
- 複数ユーザーが同時にアップロードしてもuser_idで管理できる
- 画像アップロード後に「どの旅行記録にも使わなかった」場合のクリーンアップ設計が重要

---

## 7. S3/CloudFront設定例
- バケット作成時はprivate推奨
- CORS設定でAPI/フロントからのアクセス許可
- CloudFront経由で配信する場合はオリジンにS3を指定

---

## 8. 今後の拡張案
- Cloudinary等の画像最適化サービス連携
- 動画ファイル対応
- 画像の自動タグ付け・AI解析

---

## 9. 参考
- [Laravel公式：ファイルストレージ](https://laravel.com/docs/10.x/filesystem)
- [AWS公式：S3バケットのベストプラクティス](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/security-best-practices.html)
- [Intervention Image](https://image.intervention.io/) 

--- 
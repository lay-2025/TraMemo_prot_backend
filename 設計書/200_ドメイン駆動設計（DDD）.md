# 200_ドメイン駆動設計（DDD）

## 目的
本ドキュメントは、TraMemoプロジェクトにおけるドメイン駆動設計（DDD）の採用理由、構成方針、レイヤー構成、ディレクトリ構成、エンティティ設計方針などを体系的にまとめ、開発・保守・拡張の指針とすることを目的とします。

---

## 1. DDD採用の背景と狙い

- 複雑なビジネスロジックを明確に分離し、保守性・拡張性を高めるためDDDを採用
- ドメイン知識をコード構造に反映しやすく、将来的な機能追加や仕様変更にも柔軟に対応可能
- 各レイヤーの責務を明確化し、テスト容易性・再利用性を向上

---

## 2. レイヤー構成と責務

DDDの基本的なレイヤー構成は以下の通りです。

- **Domain層**
    - ビジネスロジックの中心。エンティティ、値オブジェクト、リポジトリインターフェース等を配置。
- **Application層**
    - ユースケースやアプリケーションサービスを配置。複数ドメインのリポジトリを組み合わせて業務処理を実現。
- **Infrastructure層**
    - DBや外部サービスとの連携。Eloquentモデルやリポジトリ実装を配置。
- **Presentation層（Http/Controllers）**
    - APIエンドポイントの受付。リクエストバリデーション、ユースケース呼び出し、レスポンス返却を担当。

---

## 3. ディレクトリ構成（例）

```
app/
├── Domain/
│   ├── Travel/
│   │   ├── Entities/
│   │   └── Repositories/
│   ├── Photo/
│   │   ├── Entities/
│   │   └── Repositories/
│   └── User/
│       ├── Entities/
│       └── Repositories/
├── Application/
│   ├── Travel/
│   │   └── UseCases/
│   ├── User/
│   │   ├── UseCases/
│   │   └── Services/
├── Infrastructure/
│   ├── Travel/
│   │   ├── Models/
│   │   └── Repositories/
│   ├── Photo/
│   │   ├── Models/
│   │   └── Repositories/
│   └── User/
│       ├── Models/
│       └── Repositories/
├── Http/
│   ├── Controllers/
│   │   ├── Api/
│   │   ├── Middleware/
│   │   └── Resources/
```

---

## 4. ドメイン一覧

- **Travel**：旅行記録本体、旅行スポット、公開範囲、都道府県等
- **Photo**：旅行に紐づく写真管理
- **Tag**：タグ管理と旅行との多対多紐付け
- **Comment**：コメント管理
- **Favorite**：お気に入り管理
- **Like**：いいね管理
- **User**：ユーザー管理・認証・プロフィール

---

## 5. 業務処理の流れ（例：旅行記録作成）

1. **コントローラ**：リクエスト受付・バリデーション・ユースケース呼び出し
2. **ユースケース（UseCase）**：複数リポジトリを組み合わせてトランザクション処理
3. **リポジトリ**：永続化処理（例：TravelRepository, PhotoRepository, TagRepository）
4. **モデル**：EloquentモデルはInfrastructure層のModels配下に配置

---

## 6. 設計方針・命名規則

- ドメインごとにディレクトリを分割
- リポジトリはインターフェース（Domain）と実装（Infrastructure）で分離
- ユースケースはApplication層に配置し、複数リポジトリを組み合わせる
- モデル名・テーブル名・APIパスは英語小文字複数形を基本とする

---

## 7. エンティティ設計方針

- **不変パラメータ＋コンストラクタ注入型（推奨）**
    - 生成時に全ての値をコンストラクタで受け取り、生成後は原則として値を変更しない（immutable設計）
    - 一貫性・型安全性・テスト容易性が高まる
    - 値の変更が必要な場合は、ドメイン知識に基づいた明示的なメソッド（例：changeName()等）を用意

```php
class TravelEntity
{
    public function __construct(
        public int $id,
        public string $title,
        public ?string $description,
        // ...他プロパティ
    ) {}
}
```

- **プロパティ＋セッター型（非推奨）**
    - 柔軟に値を変更できるが、一貫性が崩れやすい
    - setter乱用でドメイン知識が薄まるリスク

---

## 8. 今後の拡張方針

- 新ドメイン追加時はDomain/Application/Infrastructure配下に同様の構成で追加
- ユースケースが複雑化した場合はサービスクラスやDTOの導入も検討
- エンティティ設計は「不変パラメータ＋コンストラクタ注入」型を基本とし、全体の一貫性を維持

---

## 9. 補足

- 詳細な設計方針やコード例は関連設計書やリポジトリREADMEも参照
- 質問や不明点はチーム内で随時共有・議論すること 
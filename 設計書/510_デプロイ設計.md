# 510_デプロイ設計書

## 1. 目的
本ドキュメントは、TraMemoプロジェクトのGCP環境におけるデプロイ設計・構成・設定値・セキュリティ・運用観点を体系的にまとめ、安定した本番運用・保守の指針とすることを目的とします。

---

## 2. アーキテクチャ設計

### 2.1 採用サービス
| サービス | 用途 |
|----------|------|
| Cloud Run | Laravel/Reactアプリケーション実行（API/フロント） |
| Cloud SQL | MySQLデータベース |
| Cloud Storage | 画像ファイル保存 |
| Cloud CDN | 静的ファイル・画像配信 |
| Cloud Load Balancing | ロードバランサー（独自ドメイン/SSL対応時） |
| Cloud Monitoring/Logging | 監視・ログ管理 |
| Secret Manager | 機密情報管理 |

### 2.2 システム構成図（概要）
```mermaid
graph TB
    U[ユーザー]
    CDN[Cloud CDN]
    LB[Cloud Load Balancing]
    FE[Cloud Run Frontend (nginx+React)]
    BE[Cloud Run Backend (nginx+Laravel)]
    DB[(Cloud SQL MySQL)]
    GCS[Cloud Storage]
    SM[Secret Manager]
    MON[Cloud Monitoring/Logging]
    EXT[外部API（Google Maps, Clerk等）]

    U --> CDN
    CDN --> LB
    LB --> FE
    FE --> BE
    BE --> DB
    BE --> GCS
    BE --> EXT
    BE --> SM
    FE --> MON
    BE --> MON
```

### 2.3 プロジェクト構成

```
TraMemo_prot_backend/
├── src/                    # Laravelアプリケーション
├── infra/
│   ├── gcp/               # GCP設定ファイル
│   │   ├── terraform/     # Terraform設定
│   │   ├── docker/        # Docker設定
│   │   └── scripts/       # デプロイスクリプト
│   └── docker-compose.yml # 開発環境用
└── 設計書/
```

---

## 3. リソース設計・構成

### 3.1 Cloud Run
- **フロントエンド**: nginx + Reactビルド配信
- **バックエンド**: nginx + PHP-FPM + Laravel
- **スケーリング**: オートスケール（0-1000インスタンス）
- **リソース**: メモリ/CPUは負荷に応じて調整
- **環境変数**: 下記参照

### 3.2 Cloud SQL
- **エンジン**: MySQL 8.0
- **インスタンス**: db-f1-micro（開発）/db-n1-standard-1（本番）
- **接続方式**: Cloud SQL Auth Proxy（推奨）
- **バックアップ**: 自動バックアップ（7日間）
- **パブリックIP無効化**

### 3.3 Cloud Storage
- **バケット名**: traMemo-images
- **アクセス制御**: IAM/署名付きURL
- **ライフサイクル**: 30日後Nearline等、コスト最適化

### 3.4 Cloud CDN/Load Balancing
- **CDN**: 画像・静的ファイル配信
- **LB**: 独自ドメイン/SSL対応時に利用

### 3.5 Secret Manager
- **用途**: DBパスワード、APP_KEY、Clerkシークレット等の管理
- **Cloud Runにマウント**: 環境変数またはファイルとして

### 3.6 監視・ロギング
- **Cloud Monitoring/Logging**: サービスごとにメトリクス・アラート設定
- **ログ保持**: 30日間

---

## 4. 環境変数・シークレット設計

### 4.1 Cloud Runの環境変数で管理する値
| 変数名                        | 用途・役割                        | 取得・設定方法例                                      |
|-------------------------------|------------------------------------|------------------------------------------------------|
| APP_ENV                       | 環境名（例: production）           | 固定値 "production"                                  |
| APP_URL                       | サイトのURL                        | 公開URLを指定                                        |
| DB_HOST                       | Cloud SQLのUNIXソケット接続名      | `/cloudsql/プロジェクトID:リージョン:DB名` 形式       |
| DB_DATABASE                   | DB名                               | Cloud SQL作成時の値                                  |
| DB_USERNAME                   | DBユーザー名                       | Cloud SQL作成時の値                                  |
| GOOGLE_CLOUD_PROJECT_ID       | GCPプロジェクトID                  | `gcloud config get-value project` で取得             |
| GOOGLE_CLOUD_STORAGE_BUCKET   | Cloud Storageバケット名            | GCPコンソールで確認                                  |
| GOOGLE_CLOUD_STORAGE_URL      | バケットの公開URL                  | `https://storage.googleapis.com/<バケット名>`         |
| CLERK_PUBLISHABLE_KEY         | Clerk公開キー                      | Clerk管理画面で取得                                  |
| CLERK_AUTHORIZED_PARTY        | Clerk認証パーティ                  | Clerk管理画面で取得                                  |
| CACHE_DRIVER, SESSION_DRIVER  | キャッシュ/セッション設定          | 必要に応じて指定                                     |
| QUEUE_CONNECTION              | キュー接続設定                     | 必要に応じて指定                                     |
| MAIL_MAILER, MAIL_HOST, ...   | メール送信設定                     | 必要に応じて指定                                     |
| LOG_CHANNEL, LOG_LEVEL        | ログ出力設定                       | 必要に応じて指定                                     |
| SANCTUM_STATEFUL_DOMAINS      | Sanctum用ドメイン設定              | 必要に応じて指定                                     |

### 4.2 Secret Managerで管理しCloud Runにマウントする値（機密情報）
| 変数名                     | 用途・役割              | 取得・設定方法例                        |
|----------------------------|------------------------|----------------------------------------|
| APP_KEY                    | Laravel暗号化キー      | `php artisan key:generate --show`      |
| DB_PASSWORD                | DBパスワード           | Cloud SQL作成時の値                    |
| CLERK_SECRET_KEY           | Clerkシークレットキー  | Clerk管理画面で取得                    |
| CLERK_WEBHOOK_SIGNING_SECRET| Clerk Webhook署名検証用| Clerk管理画面で取得                    |
| AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_DEFAULT_REGION | AWS連携用 | 必要に応じて指定                      |
| その他APIキー等            | 外部APIやメール等      | 各サービス管理画面で取得                |

---

## 5. セキュリティ設計
- サービスアカウントは用途ごとに分離し、最小権限のみ付与
- Cloud SQLはパブリックIP無効化、Auth Proxy経由で接続
- Cloud StorageはバケットレベルでIAM制御、公開アクセス無効化
- Secret Managerで機密情報を一元管理
- Cloud Run/Jobには必要なサービスアカウントを明示的に指定
- APIキー・シークレットは定期的にローテーション
- CORS/レート制限/監視アラート等も適切に設定

---

## 6. 運用・コスト観点
- Cloud Run/Cloud SQL/Cloud Storage/Cloud CDNの無料枠を活用
- Cloud Runの最小インスタンス数0、最大数制限でコスト抑制
- Cloud SQLはasia-northeast1リージョンでは無料枠対象外に注意
- Cloud Storageはライフサイクル管理でコスト最適化
- コストアラート・モニタリングを必ず設定

---

## 7. 今後の拡張性・補足
- 独自ドメイン/SSL対応時はCloud Load Balancing/Managed SSLを追加
- サービスアカウントの監査・権限見直しを定期的に実施
- Sentry/Slack等の外部監視・通知サービス連携も推奨
- Terraform等によるIaC管理も推奨

---

*（最終更新日: 2024-07-xx）* 
# 410_APIエンドポイント定義

## 1. エンドポイント一覧

### ユーザー関連
- `GET /api/user`（認証必須）

### 旅行記録関連
- `GET /api/travels`（認証不要）
- `GET /api/travels/{id}`（認証不要）
- `POST /api/travels`（認証必須）

### Webhook関連
- `POST /api/webhook/clerk`（認証不要、Clerk署名検証）

---

## 2. 各エンドポイント詳細

### 2.1 ユーザー情報取得
**GET /api/user**
- 認証: 必須
- レスポンス:
```json
{
    "success": true,
    "data": {
        "clerk_user_id": "user_xxxxxxxxxxxxx"
    }
}
```

---

### 2.2 旅行記録一覧取得
**GET /api/travels**
- 認証: 不要
- 概要: 旅行記録の一覧を取得する。検索・フィルタ・ソート・ページネーション機能に対応

#### クエリパラメータ
| パラメータ | 型 | 必須 | デフォルト | 説明 | 例 |
|-----------|----|------|-----------|------|-----|
| page | integer | × | 1 | ページ番号（1以上） | 1 |
| limit | integer | × | 12 | 1ページあたりの件数（1-100） | 12 |
| query | string | × | - | 検索キーワード（タイトル・説明・タグ・ユーザー名） | "京都" |
| locationCategory | integer | × | - | 場所カテゴリ（0：国内、1：海外） | 0 |
| prefecture | integer | × | - | 都道府県ID（定数ファイルに従う） | 26 |
| country | integer | × | - | 国ID（定数ファイルに従う） | 7 |
| visibility | integer | × | 1 | 公開設定（0：非公開、1：公開） | 1 |
| tags | array | × | - | タグ配列（カンマ区切り） | "京都,紅葉" |
| dateFrom | string | × | - | 開始日（YYYY-MM-DD） | "2024-01-01" |
| dateTo | string | × | - | 終了日（YYYY-MM-DD） | "2024-12-31" |
| minLikes | integer | × | - | 最小いいね数 | 10 |
| minComments | integer | × | - | 最小コメント数 | 5 |
| sortBy | string | × | "created_at" | ソート項目（created_at, likes, title, date） | "likes" |
| sortOrder | string | × | "desc" | ソート順序（asc, desc） | "desc" |
| user_id | integer | × | - | 特定ユーザーの旅行記録のみ取得 | 1 |

#### リクエスト例
```
GET /api/travels?page=1&limit=12&query=京都&locationCategory=0&sortBy=likes&sortOrder=desc
```

#### レスポンス
**成功時（200 OK）**
```json
{
    "success": true,
    "data": [
        {
            "id": 1,
            "title": "京都の古都を巡る旅",
            "location": "京都府, 日本",
            "date": "2024-10-15 - 2024-10-20",
            "duration": "6日間",
            "images": ["https://example.com/photo1.jpg"],
            "description": "京都の伝統的な寺院や庭園を訪れ、日本の歴史と文化に触れる旅。",
            "user": {
                "id": 1,
                "name": "田中太郎",
                "avatar": "https://example.com/avatar.jpg"
            },
            "likes": 124,
            "commentCount": 18,
            "tags": ["京都", "寺院", "日本文化", "紅葉"],
            "locationCategory": 0,
            "visibility": 1,
            "createdAt": "2024-10-25T10:00:00Z",
            "updatedAt": "2024-10-25T10:00:00Z"
        }
    ],
    "meta": {
        "current_page": 1,
        "last_page": 5,
        "per_page": 12,
        "total": 58
    }
}
```

#### レスポンスパラメータ詳細

**data配列の要素**
| パラメータ | 型 | 説明 | 例 |
|-----------|----|------|-----|
| id | integer | 旅行記録ID | 1 |
| title | string | 旅行タイトル | "京都の古都を巡る旅" |
| location | string | 旅行先（都道府県, 国名） | "京都府, 日本" |
| date | string | 旅行期間 | "2024-10-15 - 2024-10-20" |
| duration | string | 旅行日数 | "6日間" |
| images | array | 画像URL配列 | ["https://example.com/photo1.jpg"] |
| description | string | 旅行の説明 | "京都の伝統的な寺院や庭園を訪れ..." |
| user | object | ユーザー情報 | 下記参照 |
| likes | integer | いいね数 | 124 |
| commentCount | integer | コメント数 | 18 |
| tags | array | タグ配列 | ["京都", "寺院", "日本文化"] |
| locationCategory | integer | 場所カテゴリ（0：国内、1：海外） | 0 |
| visibility | integer | 公開設定（0：非公開、1：公開） | 1 |
| createdAt | string | 作成日時（ISO 8601） | "2024-10-25T10:00:00Z" |
| updatedAt | string | 更新日時（ISO 8601） | "2024-10-25T10:00:00Z" |

**userオブジェクト**
| パラメータ | 型 | 説明 | 例 |
|-----------|----|------|-----|
| id | integer | ユーザーID | 1 |
| name | string | ユーザー名 | "田中太郎" |
| avatar | string | アバター画像URL | "https://example.com/avatar.jpg" |

**metaオブジェクト**
| パラメータ | 型 | 説明 | 例 |
|-----------|----|------|-----|
| current_page | integer | 現在のページ番号 | 1 |
| last_page | integer | 最後のページ番号 | 5 |
| per_page | integer | 1ページあたりの件数 | 12 |
| total | integer | 総件数 | 58 |

#### エラーレスポンス
**400 Bad Request**
```json
{
    "success": false,
    "message": "Invalid parameters",
    "errors": {
        "page": ["Page must be greater than 0"],
        "limit": ["Limit must be between 1 and 100"]
    }
}
```

**500 Internal Server Error**
```json
{
    "success": false,
    "message": "Internal server error"
}
```

#### 検索・フィルタ機能
- **キーワード検索**: タイトル、説明文、タグ、ユーザー名で部分一致検索
- **場所フィルタ**: 国内/海外、都道府県、国名で絞り込み
- **日付フィルタ**: 旅行期間で絞り込み
- **数値フィルタ**: いいね数、コメント数で絞り込み
- **ソート機能**: 作成日時、いいね数、タイトル、旅行日でソート
- **ページネーション**: 大量データの効率的な表示

#### 実装上の注意点
- 検索クエリは部分一致（大文字小文字区別なし）
- 複数条件の組み合わせに対応
- パフォーマンスを考慮したインデックス設計が必要
- 認証不要だが、将来的にユーザー固有の機能追加を考慮

---

### 2.3 旅行記録詳細取得
**GET /api/travels/{id}**
- 認証: 不要

#### パスパラメータ
| パラメータ | 型 | 必須 | 説明 | 例 |
|-----------|----|------|------|-----|
| id | integer | ○ | 旅行記録ID | 1 |

- レスポンス例:
```json
{
    "success": true,
    "data": {
        "id": 1,
        "title": "京都の古都を巡る旅",
        "location": "京都駅到着",
        "date": "2024-10-15 - 2024-10-20",
        "duration": "6日間",
        "images": ["https://example.com/photo1.jpg"],
        "description": "京都の伝統的な寺院や庭園を訪れ...",
        "user": {
            "name": "ユーザー名",
            "avatar": "https://example.com/avatar.jpg",
            "bio": "自己紹介"
        },
        "likes": 5,
        "commentCount": 2,
        "tags": ["京都", "紅葉", "寺院"],
        "locations": [
            {
                "name": "京都駅到着",
                "lat": 34.985849,
                "lng": 135.758766,
                "description": "みんなでここに集合",
                "orderIndex": 1
            }
        ],
        "itinerary": [
            {
                "day": 1,
                "date": "2024-10-15",
                "activities": [
                    {
                        "time": "10:00",
                        "name": "京都駅到着",
                        "description": "集合場所"
                    },
                    {
                        "time": "14:00",
                        "name": "金閣寺",
                        "description": "世界遺産の寺院"
                    }
                ]
            }
        ]
    }
}
```

---

### 2.4 旅行記録作成
**POST /api/travels**
- 認証: 必須
- 概要: 新しい旅行記録を作成

#### 基本パラメータ
| パラメータ | 型 | 必須 | 説明 | 例 |
|-----------|----|------|------|-----|
| title | string | ○ | 旅行タイトル（最大255文字） | "京都の古都を巡る旅" |
| description | string | × | 旅行の説明 | "京都の伝統的な寺院や庭園を訪れる旅" |
| startDate | string | ○ | 開始日（YYYY-MM-DD） | "2024-10-15" |
| endDate | string | ○ | 終了日（YYYY-MM-DD、開始日以降） | "2024-10-20" |
| visibility | integer | ○ | 公開設定（0：private、1：public） | 1 |
| locationCategory | integer | × | 場所カテゴリ（0：日本国内、1：海外） | 0 |
| prefecture | integer | × | 都道府県No（定数ファイルに従う） | 26（京都府） |
| country | integer | × | 国No（定数ファイルに従う） | null |
| tags | array | × | タグ一覧（文字列配列） | ["京都", "紅葉"] |
| locations | array | ○ | スポット情報の配列 | 下記参照 |
| images | array | × | 画像URLの配列 | ["https://example.com/photo1.jpg"] |

#### locations配列の要素
| パラメータ | 型 | 必須 | 説明 | 例 |
|-----------|----|------|------|-----|
| order | integer | ○ | スポットの表示順 | 1 |
| name | string | ○ | スポット名（最大255文字） | "京都駅" |
| lat | numeric | × | 緯度 | 34.985849 |
| lng | numeric | × | 経度 | 135.758766 |
| description | string | × | スポットの説明・メモ | "集合場所" |
| visitDate | string | ○ | 訪問日（YYYY-MM-DD） | "2024-10-15" |
| visitTime | string | × | 訪問時刻（HH:MM） | "10:00" |

- リクエストボディ例:
```json
{
    "title": "京都の古都を巡る旅",
    "description": "京都の伝統的な寺院や庭園を訪れる旅",
    "startDate": "2024-10-15",
    "endDate": "2024-10-20",
    "visibility": 1,
    "location_category": 0,
    "prefecture": 26,
    "country": null,
    "tags": ["京都", "紅葉", "寺院"],
    "locations": [
        {
            "order": 1,
            "name": "京都駅",
            "lat": 34.985849,
            "lng": 135.758766,
            "description": "集合場所",
            "visitDate": "2024-10-15",
            "visitTime": "10:00"
        }
    ],
    "images": [
        "https://example.com/photo1.jpg"
    ]
}
```
- レスポンス例（201 Created）:
```json
{
    "success": true,
    "message": "Travel created successfully",
    "data": {
        "id": 1,
        "title": "京都の古都を巡る旅",
        "user_id": 1,
        "description": "京都の伝統的な寺院や庭園を訪れる旅",
        "start_date": "2024-10-15",
        "end_date": "2024-10-20",
        "visibility": 1,
        "location_category": 0,
        "prefecture": 26,
        "country": null,
        "created_at": "2024-01-15T10:30:00.000000Z",
        "updated_at": "2024-01-15T10:30:00.000000Z",
        "travelSpots": [
            {
                "id": 1,
                "travel_id": 1,
                "day_number": null,
                "visit_date": "2024-10-15",
                "visit_time": "10:00",
                "name": "京都駅",
                "latitude": 34.985849,
                "longitude": 135.758766,
                "order_index": 1,
                "memo": "集合場所"
            }
        ],
        "photos": [
            {
                "id": 1,
                "travel_id": 1,
                "travel_spot_id": 1,
                "url": "https://example.com/photo1.jpg",
                "thumbnail_url": null,
                "caption": null
            }
        ],
        "tags": [
            {
                "id": 1,
                "name": "京都"
            }
        ]
    }
}
```

---

### 2.5 Clerk Webhook
**POST /api/webhook/clerk**
- 認証: 不要（Clerk署名検証）
- 用途: ユーザー作成・更新・削除イベントの処理、認証状態の同期

---



*（最終更新日: 2024-07-xx）* 